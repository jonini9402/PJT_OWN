<?xml version="1.0" encoding="UTF-8" ?>

<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "https://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.own.domain.user.dao.UserDao">

	<!-- 회원가입 -->
	<insert id="signupUser"
		parameterType="com.own.domain.user.dto.request.UserSignupRequest">
		INSERT INTO users
		(
		name, nickname, email, password, profile_img
		)
		VALUES
		(
		#{name}, #{nickname}, #{email}, #{password}, #{profileImg}
		)
	</insert>

	<!-- userId로 유저 조회 -->
	<select id="selectUserById"
		resultType="com.own.domain.user.dto.response.UserResponse">
		SELECT
		user_id AS userId, name, nickname, email,
		profile_img AS profileImg,
		tier_level AS tierLevel
		FROM users
		WHERE user_id = #{userId} AND deleted_at IS
		NULL
	</select>

	<!-- 유저 정보수정 -->
	<update id="updateUser">
		UPDATE users  <set>
        <if test="user.profileImg != null">
            profile_img = #{user.profileImg},
        </if>
        <if test="user.newPassword != null and user.newPassword != ''">
            password = #{user.newPassword},
        </if>
        </set>
		WHERE user_id = #{userId} AND deleted_at IS NULL
	</update>

	<!-- 회원탈퇴 -->

	<update id="deleteUser">
		UPDATE users
		SET deleted_at = NOW()
		WHERE user_id =
		#{userId} AND deleted_at IS NULL
	</update>

	<!-- 유저 등급 조회 -->
	<select id="selectUserTierById"
		resultType="com.own.domain.user.dto.response.UserTierResponse">
		SELECT
		tier_level AS tierLevel
		FROM users
		WHERE user_id = #{userId} AND deleted_at IS
		NULL
	</select>

	<!-- 이메일로 유저 조회 -->
	<select id="selectUserByEmail" parameterType="string"
		resultType="com.own.domain.user.dto.model.User">
		SELECT
		user_id, name, nickname, email, password, profile_img, tier_level, status
		FROM
		users
		WHERE email = #{email} AND status = true AND deleted_at IS NULL

	</select>

	<!-- 닉네임으로 유저 조회 (중복 체크용) -->
	<select id="selectUserByNickname" parameterType="string"
		resultType="com.own.domain.user.dto.model.User">
		SELECT
		user_id, name, nickname, email, password, profile_img, tier_level,
		status
		FROM users
		WHERE nickname = #{nickname} AND status = true AND deleted_at IS NULL
	</select>
	
	<!-- 유저 게시글 수 조회 -->
	<select id="countPostsByUserId" parameterType="int" resultType="int">
	    SELECT COUNT(*) 
	    FROM post 
	    WHERE user_id = #{userId}
	</select>
	
	<update id="increasePostCount">
		UPDATE users
		SET user_post_count = user_post_count + 1
		WHERE user_id = #{userId}
	</update>
	
	<update id="updateTierLevel">
		UPDATE users
		SET tier_level =
			CASE
				WHEN user_post_count >= 7 THEN 3
				WHEN user_post_count >= 4 THEN 2
				ELSE 1
			END
		WHERE user_id = #{userId}
	</update>

</mapper>
